{% extends "base.html" %}
{% block content %}

<div class="container mt-4">
  <div class="nav-buttons mb-3">
    <button onclick="history.back()" class="btn btn-secondary me-2">
      <i class="fas fa-arrow-left me-1"></i> Previous
    </button>
    <a href="/" class="btn btn-primary me-2">
      <i class="fas fa-home me-1"></i> Home
    </a>
    <button onclick="history.forward()" class="btn btn-secondary">
      Next <i class="fas fa-arrow-right ms-1"></i>
    </button>
  </div>

  <h2 class="output-title mt-4 mb-4">final Output - Chart View</h2>

  <!-- Add this code after your existing header section -->
  <div class="filter-section mb-4 p-3 bg-light rounded shadow-sm">
      <h5 class="filter-title mb-3">Filter Data</h5>
      
      <!-- Column Dropdown -->
      <div class="row g-3 align-items-end">
          <div class="col-md-4">
              <label for="filterColumn" class="form-label">Select Column</label>
              <select class="form-select" id="filterColumn">
                  <option value="">Choose column...</option>
                  {% for col in column_values.keys() %}
                      <option value="{{ col }}">{{ col }}</option>
                  {% endfor %}
              </select>
          </div>
          
          <!-- Values Checkboxes Container -->
          <div class="col-md-6">
              <div id="valueCheckboxes" class="d-none">
                  <label class="form-label">Select Values</label>
                  <div class="checkbox-container border rounded p-2" style="max-height: 200px; overflow-y: auto;">
                      <!-- Checkboxes will be dynamically added here -->
                  </div>
              </div>
          </div>
          
          <!-- Apply Filter Button -->
          <div class="col-md-2">
              <button id="applyFilter" class="btn btn-primary" disabled>
                  Apply Filter
              </button>
          </div>
      </div>
      
      <!-- Selected Filters Display -->
      <div id="selectedFilters" class="mt-3">
          <!-- Filter chips will be displayed here -->
      </div>
  </div>

  <!-- ðŸ§® Chart Grid -->
  <div class="row g-4" id="chartsGrid">
    {% if chart_files %}
        {% for chart_file in chart_files %}
            <div class="col-md-6">
                <div class="chart-container bg-white p-3 rounded shadow-sm">
                    <h3 class="chart-title mb-3">Chart {{ loop.index }}</h3>
                    <iframe 
                        src="{{ url_for('static', filename=chart_file) }}"
                        class="w-100 chart-iframe"
                        style="height: 500px; border: none; border-radius: 8px;"
                        allowfullscreen
                        loading="lazy">
                    </iframe>
                </div>
            </div>
        {% endfor %}
    {% else %}
        <div class="col-12">
            <div class="alert alert-info">No charts generated yet.</div>
        </div>
    {% endif %}
</div>

    <div class="actions mt-3">
        <a href="/data_model_2" class="chart-view-btn btn btn-primary">Back to Chart Configuration</a>
    </div>
</div>


<script id="json-data" type="application/json">
{{ joined_data|tojson|safe }}
</script>
<script id="column-values" type="application/json">
{{ column_values|tojson|safe }}
</script>
<!-- <script>
// Initialize filters map
const activeFilters = new Map();

// Handle column selection
document.getElementById('filterColumn').addEventListener('change', function() {
    const column = this.value;
    const checkboxContainer = document.getElementById('valueCheckboxes');
    const applyButton = document.getElementById('applyFilter');
    
    if (!column) {
        checkboxContainer.classList.add('d-none');
        applyButton.disabled = true;
        return;
    }
    
    const values = {{ column_values|tojson|safe }};
    const columnValues = values[column] || [];
    
    const checkboxesHTML = columnValues.map(value => `
        <div class="form-check">
            <input class="form-check-input" type="checkbox" 
                   value="${value}" 
                   id="check_${typeof value === 'string' ? value : String(value).replace(/[^a-zA-Z0-9]/g, '_')}">
            <label class="form-check-label" for="check_${typeof value === 'string' ? value : String(value).replace(/[^a-zA-Z0-9]/g, '_')}">
                ${value}
            </label>
        </div>
    `).join('');
    
    checkboxContainer.querySelector('.checkbox-container').innerHTML = checkboxesHTML;
    checkboxContainer.classList.remove('d-none');
    applyButton.disabled = false;
});

// Handle filter application
document.getElementById('applyFilter').addEventListener('click', function() {
    const column = document.getElementById('filterColumn').value;
    const selectedValues = Array.from(
        document.querySelectorAll('#valueCheckboxes input:checked'),
        cb => isNaN(cb.value) ? cb.value : Number(cb.value)
    );
    
    if (selectedValues.length > 0) {
        activeFilters.set(column, selectedValues);
        updateFilterChips();
        applyFiltersToCharts();
    }
});

// Update filter chips display
function updateFilterChips() {
    const container = document.getElementById('selectedFilters');
    container.innerHTML = '';
    
    if (activeFilters.size === 0) {
        return;
    }
    
    activeFilters.forEach((values, column) => {
        const chip = document.createElement('div');
        chip.className = 'badge bg-primary me-2 mb-2 p-2';
        chip.innerHTML = `
            ${column}: ${values.join(', ')}
            <button type="button" class="btn-close btn-close-white ms-2" 
                    aria-label="Remove" 
                    onclick="removeFilter('${column}')">
            </button>
        `;
        container.appendChild(chip);
    });
}

// Remove filter
function removeFilter(column) {
    activeFilters.delete(column);
    updateFilterChips();
    applyFiltersToCharts();
}

// Apply filters to charts
function applyFiltersToCharts() {
    let filteredData = {{ joined_data|tojson|safe }};
    
    activeFilters.forEach((values, column) => {
        filteredData = filteredData.filter(row => {
            const rowValue = row[column];
            return values.includes(
                typeof rowValue === 'number' ? rowValue : String(rowValue)
            );
        });
    });
    
    document.querySelectorAll('.chart-container iframe').forEach(iframe => {
        if (iframe.contentWindow && iframe.contentWindow.updateChartData) {
            iframe.contentWindow.updateChartData(filteredData);
        }
    });
}
</script> -->
<!-- Add this JavaScript code at the end of your file, before </body> -->
<script>

// line chart zoom aware behavior
document.addEventListener("DOMContentLoaded", function () {
  // Find all Plotly charts on the page
  const plots = document.querySelectorAll("div.js-plotly-plot");

  plots.forEach((plot) => {
    const chartType = plot.layout?.meta?.chartType;
    if (chartType !== "line_zoom_labels") return;

    const totalPoints = plot.data[0].x.length;

    plot.on("plotly_relayout", function (eventData) {
      if (!eventData["xaxis.range[0]"] || !eventData["xaxis.range[1]"]) return;

      const x0 = eventData["xaxis.range[0]"];
      const x1 = eventData["xaxis.range[1]"];
      const visibleSpan = x1 - x0;

      // Show labels only if zoomed enough (25% of original range)
      const showLabels = visibleSpan < totalPoints * 0.25;

      Plotly.restyle(
        plot,
        { text: [showLabels ? plot.data[0].y.map(String) : null] },
        [0]
      );
    });
  });
});

let activeFilters = new Map(); // Store active filters

document.getElementById('filterColumn').addEventListener('change', function() {
    const column = this.value;
    const checkboxContainer = document.getElementById('valueCheckboxes');
    const applyButton = document.getElementById('applyFilter');
    
    if (!column) {
        checkboxContainer.classList.add('d-none');
        applyButton.disabled = true;
        return;
    }
    
    // Get unique values for selected column
    const jsonDataElement = document.getElementById('column-values');
    const values = JSON.parse(jsonDataElement.textContent);
    const columnValues = values[column];
    
    // Create checkboxes
    const checkboxesHTML = columnValues.map(value => `
        <div class="form-check">
            <input class="form-check-input" type="checkbox" value="${value}" id="check_${value}">
            <label class="form-check-label" for="check_${value}">
                ${value}
            </label>
        </div>
    `).join('');
    
    checkboxContainer.querySelector('.checkbox-container').innerHTML = checkboxesHTML;
    checkboxContainer.classList.remove('d-none');
    applyButton.disabled = false;
});

document.getElementById('applyFilter').addEventListener('click', function() {
    const column = document.getElementById('filterColumn').value;
    const selectedValues = [...document.querySelectorAll('#valueCheckboxes input:checked')]
        .map(cb => cb.value);
    
    if (selectedValues.length > 0) {
        // Store the filter
        activeFilters.set(column, selectedValues);
        
        // Update filter chips display
        updateFilterChips();
        
        // Apply filters to charts
        applyFiltersToCharts();
    }
});

function updateFilterChips() {
    const container = document.getElementById('selectedFilters');
    container.innerHTML = '';
    
    activeFilters.forEach((values, column) => {
        const chip = document.createElement('div');
        chip.className = 'badge bg-secondary me-2 mb-2 p-2';
        chip.innerHTML = `
            ${column}: ${values.join(', ')}
            <button type="button" class="btn-close btn-close-white ms-2" 
                    aria-label="Remove" style="font-size: 0.5rem;"
                    onclick="removeFilter('${column}')"></button>
        `;
        container.appendChild(chip);
    });
}

function removeFilter(column) {
    activeFilters.delete(column);
    updateFilterChips();
    applyFiltersToCharts();
}

function applyFiltersToCharts() {
    let filteredData = JSON.parse(document.getElementById('json-data').textContent);
    
    // Apply each active filter
    activeFilters.forEach((values, column) => {
        filteredData = filteredData.filter(row => {
            const rowValue = row[column];
            return values.includes(rowValue?.toString());
        });
    });

    // Update each chart
    document.querySelectorAll('.chart-iframe').forEach(iframe => {
        const chartType = iframe.getAttribute('data-chart-type');
        const xCol = iframe.getAttribute('data-x-col');
        const yCol = iframe.getAttribute('data-y-col');
        const operation = iframe.getAttribute('data-operation');

        // Send filtered data to all chart iframes
        document.querySelectorAll('.chart-iframe').forEach(iframe => {
            iframe.contentWindow.postMessage({
                type: "updateChartData",
                data: filteredData,
                chartType: iframe.getAttribute('data-chart-type'),
                xCol: iframe.getAttribute('data-x-col'),
                yCol: iframe.getAttribute('data-y-col'),
                operation: iframe.getAttribute('data-operation')
            }, "*");
        });
    });
}

// Add these helper functions for different chart types
function updateTableChart(iframe, filteredData) {
    const doc = iframe.contentWindow.document;
    const tableBody = doc.querySelector('table tbody');
    if (tableBody) {
        // Update table with filtered data
        const rows = filteredData.map((row, index) => `
            <tr>
                <td>${index + 1}</td>
                ${Object.values(row).map(val => `<td>${val}</td>`).join('')}
            </tr>
        `).join('');
        tableBody.innerHTML = rows;
    }
}

function updateCardChart(iframe, filteredData, yCol, operation) {
    const doc = iframe.contentWindow.document;
    const valueElement = doc.querySelector('h1');
    if (valueElement) {
        let value = 0;
        if (operation === 'sum') {
            value = filteredData.reduce((sum, row) => sum + (parseFloat(row[yCol]) || 0), 0);
        } else if (operation === 'avg') {
            value = filteredData.reduce((sum, row) => sum + (parseFloat(row[yCol]) || 0), 0) / filteredData.length;
        }
        valueElement.textContent = `â‚¹${value.toLocaleString('en-IN', {maximumFractionDigits: 0})}`;
    }
}

function updatePlotlyChart(iframe, filteredData, xCol, yCol, operation, chartType) {
    const plotlyDiv = iframe.contentWindow.document.querySelector('.js-plotly-plot');
    if (!plotlyDiv) return;

    // Process data based on operation
    let processedData = processChartData(filteredData, xCol, yCol, operation);

    // Update chart based on chart type
    if (chartType === 'bar' || chartType === 'line') {
        const update = {
            x: [processedData.map(d => d[xCol])],
            y: [processedData.map(d => d[yCol])]
        };
        iframe.contentWindow.Plotly.update(plotlyDiv, update);
    } else if (chartType === 'pie') {
        const update = {
            labels: processedData.map(d => d[xCol]),
            values: processedData.map(d => d[yCol])
        };
        iframe.contentWindow.Plotly.update(plotlyDiv, update);
    }
}

function processChartData(data, xCol, yCol, operation) {
    if (!operation || operation === 'none') return data;

    const grouped = {};
    data.forEach(row => {
        const key = row[xCol];
        if (!grouped[key]) grouped[key] = [];
        grouped[key].push(parseFloat(row[yCol]) || 0);
    });

    return Object.entries(grouped).map(([key, values]) => {
        let value;
        switch (operation) {
            case 'sum':
                value = values.reduce((a, b) => a + b, 0);
                break;
            case 'avg':
                value = values.reduce((a, b) => a + b, 0) / values.length;
                break;
            case 'count':
                value = values.length;
                break;
            case 'distinct_count':
                value = new Set(values).size;
                break;
            default:
                value = values[0];
        }
        return { [xCol]: key, [yCol]: value };
    });
}

function showChartLoading(show = true) {
    document.querySelectorAll('.chart-container').forEach(container => {
        const overlay = container.querySelector('.loading-overlay') || 
            container.appendChild(createElement('div', { className: 'loading-overlay' }, 
                'Updating chart...'));
        overlay.classList.toggle('active', show);
    });
}
</script>

<style>
.output-title {
  text-align: center;
  font-weight: bold;
  letter-spacing: 1px;
}
.chart-view-btn {
    width: 20%;
    display: block;
    margin: 1.5rem auto;
}
.chart-title {
  font-weight: 600;
  text-align: center;
  color: #333;
  background: #f8f9fa;
  padding: 8px;
  border-radius: 6px;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

/* Filter Styles */
.checkbox-container {
  max-height: 200px;
  overflow-y: auto;
  background: white;
}

.form-check {
  margin: 0.25rem 0;
}

.filter-section {
  background: #f8f9fa;
  border: 1px solid #dee2e6;
}

.filter-title {
  color: #495057;
  font-weight: 600;
}

#selectedFilters .badge {
  font-size: 0.9rem;
  font-weight: normal;
}

.btn-close-white {
  padding: 0.25rem;
  margin-left: 0.5rem;
}
.chart-container {
  position: relative;
}

.loading-overlay {
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(255, 255, 255, 0.8);
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 1000;
  display: none;
}

.loading-overlay.active {
  display: flex;
}
</style>


{% endblock %}
