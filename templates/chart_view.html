{% extends "base.html" %}
{% block content %}

<div class="container mt-4">
  <div class="nav-buttons mb-3">
    <button onclick="history.back()" class="btn btn-secondary me-2">
      <i class="fas fa-arrow-left me-1"></i> Previous
    </button>
    <a href="/" class="btn btn-primary me-2">
      <i class="fas fa-home me-1"></i> Home
    </a>
    <button onclick="history.forward()" class="btn btn-secondary">
      Next <i class="fas fa-arrow-right ms-1"></i>
    </button>
  </div>

  <h2 class="output-title mt-4 mb-4" id="defaultTitle">Dashboard - Chart View</h2>

  <!-- Add this code after your existing header section -->
  <div class="filter-section mb-4 p-3 bg-light rounded shadow-sm">
      <h5 class="filter-title mb-3">Filter Data</h5>
      
      <!-- Column Dropdown -->
      <div class="row g-3 align-items-end">
          <div class="col-md-4">
              <label for="filterColumn" class="form-label">Select Column</label>
              <select class="form-select" id="filterColumn">
                  <option value="">Choose column...</option>
                  {% for col in column_values.keys() %}
                      <option value="{{ col }}">{{ col }}</option>
                  {% endfor %}
              </select>
          </div>
          
          <!-- Values Checkboxes Container -->
          <div class="col-md-6">
              <div id="valueCheckboxes" class="d-none">
                  <label class="form-label">Select Values</label>
                  <div class="checkbox-container border rounded p-2" style="max-height: 200px; overflow-y: auto;">
                      <!-- Checkboxes will be dynamically added here -->
                  </div>
              </div>
          </div>
          
          <!-- Apply Filter Button -->
          <div class="col-md-2">
              <button id="applyFilter" class="btn btn-primary" disabled>
                  Apply Filter
              </button>
          </div>
      </div>
      
      <!-- Selected Filters Display -->
      <div id="selectedFilters" class="mt-3">
          <!-- Filter chips will be displayed here -->
      </div>
  </div>

  <!-- ðŸ§® Chart Grid -->
  <div class="row g-4" id="chartsGrid">
    {% if chart_files %}
        {% for chart_file in chart_files %}
            <div class="col-md-6">
                <div class="chart-container bg-white p-3 rounded shadow-sm">
                    <h3 class="chart-title mb-3">Chart {{ loop.index }}</h3>
                    <iframe 
                        src="{{ url_for('static', filename=chart_file) }}"
                        class="w-100 chart-iframe"
                        style="height: 500px; border: none; border-radius: 8px;"
                        
                        allowfullscreen
                        loading="lazy">
                    </iframe>
                </div>
            </div>
        {% endfor %}
    {% else %}
        <div class="col-12">
            <div class="alert alert-info">No charts generated yet.</div>
        </div>
    {% endif %}
</div>

    <div class="actions mt-3">
        <a href="/data_model_2" class="chart-view-btn btn btn-primary">Back to Chart Configuration</a>
    </div>
</div>


<script id="json-data" type="application/json">
{{ joined_data|tojson|safe }}
</script>
<script id="column-values" type="application/json">
{{ column_values|tojson|safe }}
</script>

<script>
let activeFilters = {};  // e.g. { "Region": ["East", "West"], "Category": ["A"] }

// When column changes, load checkboxes
document.getElementById('filterColumn').addEventListener('change', function() {
    const col = this.value;
    const checkboxesDiv = document.querySelector('.checkbox-container');
    const checkboxWrapper = document.getElementById('valueCheckboxes');
    const applyBtn = document.getElementById('applyFilter');
    
    checkboxesDiv.innerHTML = '';
    applyBtn.disabled = true;

    if (!col) {
        checkboxWrapper.classList.add('d-none');
        return;
    }

    // Get column values from template (rendered by Flask)
    const colValues = JSON.parse(document.getElementById('column-values').textContent);
    const values = colValues[col] || [];

    values.forEach(val => {
        const id = `chk-${col}-${val}`;
        const label = document.createElement('label');
        label.classList.add('d-block', 'mb-1');
        label.innerHTML = `
            <input type="checkbox" class="form-check-input me-1" value="${val}" id="${id}">
            ${val}
        `;
        checkboxesDiv.appendChild(label);
    });

    checkboxWrapper.classList.remove('d-none');

    checkboxesDiv.querySelectorAll('input[type="checkbox"]').forEach(chk => {
        chk.addEventListener('change', () => {
            const anyChecked = checkboxesDiv.querySelectorAll('input:checked').length > 0;
            applyBtn.disabled = !anyChecked;
        });
    });
});

// Apply filter button
document.getElementById('applyFilter').addEventListener('click', function() {
    const column = document.getElementById('filterColumn').value;
    if (!column) return;

    const selected = Array.from(document.querySelectorAll('.checkbox-container input:checked'))
        .map(cb => cb.value);

    if (selected.length === 0) return;

    // Add/replace active filter
    activeFilters[column] = selected;
    renderFilterChips();
    applyFiltersToCharts();
});

// Render chips for active filters
function renderFilterChips() {
    const container = document.getElementById('selectedFilters');
    container.innerHTML = '';

    Object.entries(activeFilters).forEach(([col, vals]) => {
        vals.forEach(val => {
            const chip = document.createElement('span');
            chip.className = 'badge bg-primary me-2 mb-2';
            chip.textContent = `${col}: ${val}`;
            chip.style.cursor = 'pointer';
            chip.onclick = () => {
                activeFilters[col] = activeFilters[col].filter(v => v !== val);
                if (activeFilters[col].length === 0) delete activeFilters[col];
                renderFilterChips();
                applyFiltersToCharts();
            };
            container.appendChild(chip);
        });
    });
}

// âœ… Send filters to all iframes
function applyFiltersToCharts() {
    const chartIframes = document.querySelectorAll('.chart-iframe');
    chartIframes.forEach(iframe => {
        iframe.contentWindow.postMessage(
            { type: 'updateFilters', filters: activeFilters },
            '*'
        );
    });
}

// Get title from localStorage and set it
window.addEventListener("DOMContentLoaded", () => {
  // Read the stored title
  const savedTitle = localStorage.getItem("dashboardTitle");

  // Update the h2 text only if we have something saved
  if (savedTitle) {
    document.getElementById("defaultTitle").textContent = savedTitle;
  }
});
</script>

<style>
.output-title {
  text-align: center;
  font-weight: bold;
  letter-spacing: 1px;
}
.chart-view-btn {
    width: 20%;
    display: block;
    margin: 1.5rem auto;
}
.chart-title {
  font-weight: 600;
  text-align: center;
  color: #333;
  background: #f8f9fa;
  padding: 8px;
  border-radius: 6px;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

/* Filter Styles */
.checkbox-container {
  max-height: 200px;
  overflow-y: auto;
  background: white;
}

.form-check {
  margin: 0.25rem 0;
}

.filter-section {
  background: #f8f9fa;
  border: 1px solid #dee2e6;
}

.filter-title {
  color: #495057;
  font-weight: 600;
}

#selectedFilters .badge {
  font-size: 0.9rem;
  font-weight: normal;
}

.btn-close-white {
  padding: 0.25rem;
  margin-left: 0.5rem;
}
.chart-container {
  position: relative;
}

.loading-overlay {
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(255, 255, 255, 0.8);
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 1000;
  display: none;
}

.loading-overlay.active {
  display: flex;
}
</style>


{% endblock %}
