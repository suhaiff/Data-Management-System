{% extends "base.html" %}
{% block content %}
<div class="nav-buttons mb-4">
    <button onclick="history.back()" class="btn btn-secondary me-2">
        <i class="fas fa-arrow-left me-1"></i> Previous
    </button>
    <a href="/" class="btn btn-primary me-2">
        <i class="fas fa-home me-1"></i> Home
    </a>
    <button onclick="history.forward()" class="btn btn-secondary">
        Next <i class="fas fa-arrow-right ms-1"></i>
    </button>
</div>

<h2 class="config2-title mb-4">Chart Configuration - Config Form</h2>

<div class="container chart-config-card">
  <div class="title-box col-md-6" id="input-section">
    <label class="form-label" for="userInput">Dashboard Title</label>
    <input class="form-control" type="text" id="userInput" placeholder="Enter Custom Title">
    <!-- <button onclick="updateHeading()">Submit</button> -->
  </div>
  <hr>
  <form method="POST" id="multiChartForm" action="/data_model_2">
    <div id="chart-forms-container">

      <!-- Template form -->
      <div class="chart-form row mb-4 p-3 border rounded chart-config" data-index="0">
        <h5>Chart #1</h5>

        <div class="row mb-3">
          <div class="col-md-6">
            <label class="form-label">Chart Title (Custom)</label>
            <input type="text" class="form-control" name="chart_title_0" placeholder="Enter custom title">
          </div>
          <div class="col-md-6">
            <label class="form-label">Select Chart Type</label>
            <select class="form-select chart-type" name="chart_type_0">
              <option value="bar">Bar Chart</option>
              <option value="line">Line Chart</option>
              <option value="pie">Pie Chart</option>
              <option value="card">Card Summary</option>
              <option value="table">Table</option>
              <option value="matrix_table">Matrix Table</option>
            </select>
          </div>
        </div>

        <div class="regular-fields">
          <div class="row mb-3">
            <div class="col-md-6">
              <label class="form-label">Select X-Axis Column</label>
              <select class="form-select" name="x_column_0">
                {% for col in columns %}
                <option value="{{ col }}">{{ col }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="col-md-6">
              <label class="form-label">Select Y-Axis Column</label>
              <select class="form-select" name="y_column_0">
                {% for col in columns %}
                <option value="{{ col }}">{{ col }}</option>
                {% endfor %}
              </select>
            </div>
          </div>
          <div class="col-md-6">
            <label class="form-label">Operation</label>
            <select class="form-select" name="operation_0">
              <option value="none">None</option>
              <option value="sum">Sum</option>
              <option value="avg">Average</option>
              <option value="count">Count</option>
              <option value="distinct_count">Distinct Count</option>
            </select>
          </div>
        </div>

        <!-- Table-specific field -->
        <div class="table-fields" style="display: none;">
          <label class="form-label">Select Columns for Table</label>
          <div class="d-flex flex-column gap-2">
            <select class="form-select table-columns">
              {% for col in columns %}
              <option value="{{ col }}">{{ col }}</option>
              {% endfor %}
            </select>
            <button type="button" class="btn btn-sm btn-success mt-2 add-column">
              + Add Column
            </button>
          </div>
          <div class="selected-columns mt-2"></div>
        </div>

        <!-- Matrix Table-specific fields -->
        <div class="matrix-table-fields" style="display: none;">

          <div class="form-group" style="margin-bottom:12px;">
              <label for="matrix_row_dim" style="font-weight:600;">Row Dimension:</label>
              <select name="matrix_row_dim" id="matrix_row_dim" class="form-select form-select-sm">
                  <option value="">-- Select Row Field --</option>
                  {% for col in columns %}
                  <option value="{{ col }}">{{ col }}</option>
                  {% endfor %}
              </select>
              <small class="form-text text-muted">This becomes the row grouping (e.g. Region, Category).</small>
          </div>
          <div class="form-group" style="margin-bottom:12px;">
              <label for="matrix_col_dim" style="font-weight:600;">Column Dimension:</label>
              <select name="matrix_col_dim" id="matrix_col_dim" class="form-select form-select-sm">
                  <option value="">-- Select Column Field --</option>
                  {% for col in columns %}
                  <option value="{{ col }}">{{ col }}</option>
                  {% endfor %}
              </select>
              <small class="form-text text-muted">This becomes the table columns (e.g. Product, Month).</small>
          </div>
          <div class="form-group" style="margin-bottom:12px;">
              <label for="matrix_value_dim" style="font-weight:600;">Value (Measure):</label>
              <select name="matrix_value_dim" id="matrix_value_dim" class="form-select form-select-sm">
                  <option value="">-- Select Value Field --</option>
                  {% for col in columns %}
                  <option value="{{ col }}">{{ col }}</option>
                  {% endfor %}
              </select>
              <small class="form-text text-muted">This is the numeric value to aggregate (e.g. Amount, Quantity).</small>
          </div>

        </div>

        <!-- Hidden input to store selected columns -->
        <input type="hidden" name="selected_columns_0" class="selected_columns_input">

        <div class="row mb-3 mt-2">
          <div class="col-md-3">
            <label class="form-label">Font</label>
            <select class="form-select" name="font_0">
              <option value="Arial" style="font-family: Arial;">Arial</option>
              <option value="Verdana" style="font-family: Verdana;">Verdana</option>
              <option value="Times New Roman" style="font-family: 'Times New Roman';">Times New Roman</option>
              <option value="Georgia" style="font-family: Georgia;">Georgia</option>
              <option value="Courier New" style="font-family: 'Courier New';">Courier New</option>
              <option value="Trebuchet MS" style="font-family: 'Trebuchet MS';">Trebuchet MS</option>
              <option value="Lucida Sans" style="font-family: 'Lucida Sans';">Lucida Sans</option>
              <option value="Tahoma" style="font-family: Tahoma;">Tahoma</option>
              <option value="Comic Sans MS" style="font-family: 'Comic Sans MS';">Comic Sans</option>
              <option value="Roboto" style="font-family: Roboto;">Roboto</option>
            </select>
          </div>
          <div class="col-md-3">
            <label class="form-label">Color</label>
            <input type="color" class="form-control form-control-color" name="color_0" value="#007bff">
          </div>
        </div>

        <div class="row mb-3">
          <div class="col-md-6">
            <label class="form-label">Chart Width (px)</label>
            <input type="number" class="form-control" name="width_0" value="800" min="400" max="2000">
          </div>
          <div class="col-md-6">
            <label class="form-label">Chart Height (px)</label>
            <input type="number" class="form-control" name="height_0" value="600" min="300" max="1500">
          </div>
        </div>

        <div class="d-flex justify-content-end">
          <button type="button" class="btn btn-danger btn-sm remove-chart-btn">Remove</button>
        </div>
      </div>
      <!-- end chart-form -->

    </div>

    <div class="config-btns d-flex gap-2 mt-3">
      <button type="button" class="btn btn-success" id="addChartBtn">Add Chart</button>
      <button onclick="updateHeading()" type="submit" class="btn btn-primary">Generate All Charts</button>
      <!-- Table View button -->
      <a href="{{ url_for('table_view') }}" class="btn btn-primary">Table View</a>
    </div>  
  </form>
</div>


<script>
document.addEventListener("DOMContentLoaded", function() {
    const container = document.getElementById("chart-forms-container");
    const addBtn = document.getElementById("addChartBtn");

    addBtn.addEventListener("click", function() {
        const index = container.children.length;
        const newForm = container.children[0].cloneNode(true);
        newForm.dataset.index = index;
        newForm.querySelector("h5").textContent = `Chart #${index+1}`;

        // Update all input/select names
        const inputs = newForm.querySelectorAll("select, input");
        inputs.forEach(input => {
            const baseName = input.name.replace(/_\d+$/, "");
            input.name = `${baseName}_${index}`;
            if(input.type === "number") input.value = input.name.includes("width") ? 800 : 600;
            else if(input.type === "color") input.value = "#007bff";
            else if(input.tagName === "SELECT") input.selectedIndex = 0;
        });

        // Reset selected columns
        const hiddenInput = newForm.querySelector(".selected_columns_input");
        if (hiddenInput) {
          hiddenInput.name = `selected_columns_${index}`;
          hiddenInput.value = ""; // reset value for new form
        }

        container.appendChild(newForm);
    });

    // Remove chart
    container.addEventListener("click", function(e) {
        if(e.target.classList.contains("remove-chart-btn")) {
            const forms = container.querySelectorAll(".chart-form");
            if(forms.length > 1){
                e.target.closest(".chart-form").remove();
                // Reindex remaining
                container.querySelectorAll(".chart-form").forEach((form, idx) => {
                    form.dataset.index = idx;
                    form.querySelector("h5").textContent = `Chart #${idx+1}`;
                    const inputs = form.querySelectorAll("select, input");
                    inputs.forEach(input => {
                        const baseName = input.name.replace(/_\d+$/, "");
                        input.name = `${baseName}_${idx}`;
                    });
                });
            } else alert("At least one chart configuration is required.");
        }
    });
});

// // Chart type toggle
// Chart type toggle for regular/table/matrix-table fields
document.addEventListener("change", function(e) {
    if (e.target.classList.contains("chart-type")) {
        const container = e.target.closest(".chart-config");
        const chartType = e.target.value;

        // Get references safely
        const regularFields = container.querySelector(".regular-fields");
        const tableFields = container.querySelector(".table-fields");
        const matrixFields = container.querySelector(".matrix-table-fields");

        // Default all hidden
        if (regularFields) regularFields.style.display = "none";
        if (tableFields) tableFields.style.display = "none";
        if (matrixFields) matrixFields.style.display = "none";

        // Show based on chart type
        if (chartType === "table") {
            if (tableFields) tableFields.style.display = "block";
        } else if (chartType === "matrix_table") {
            if (matrixFields) matrixFields.style.display = "block";
        } else {
            if (regularFields) regularFields.style.display = "block";
        }
    }
});
// document.addEventListener("change", function(e){
//     if(e.target.classList.contains("chart-type")){
//         const container = e.target.closest(".chart-config");
//         const chartType = e.target.value;
//         container.querySelector(".regular-fields").style.display = (chartType === "table") ? "none" : "block";
//         container.querySelector(".table-fields").style.display = (chartType === "table") ? "block" : "none";
//     }
// });

// Add/Remove table columns
document.addEventListener("click", function(e){
    if(e.target.classList.contains("add-column") || e.target.classList.contains("remove-col")){
        const container = e.target.closest(".chart-config");
        const selectedColsDiv = container.querySelector(".selected-columns");
        const hiddenInput = container.querySelector(".selected_columns_input");
        let selectedCols = hiddenInput.value ? hiddenInput.value.split(",") : [];

        if(e.target.classList.contains("add-column")){
            const val = container.querySelector(".table-columns").value;
            if(!selectedCols.includes(val)) selectedCols.push(val);
        }
        if(e.target.classList.contains("remove-col")){
            const val = e.target.dataset.col;
            selectedCols = selectedCols.filter(c => c !== val);
        }

        // Update badges and hidden input
        selectedColsDiv.innerHTML = selectedCols.map(
            c => `<div class="badge bg-secondary p-2 me-2">
                    ${c} <button type="button" class="btn btn-sm btn-light ms-2 remove-col" data-col="${c}">-</button>
                  </div>`
        ).join("");
        hiddenInput.value = selectedCols.join(",");
    }
});


// Update heading based on user input
function updateHeading() {
  const input = document.getElementById("userInput").value.trim();
  // const heading = document.getElementById("defaultTitle");
  // Save title to localStorage so next page can read it
  localStorage.setItem("dashboardTitle", input || "Dashboard - Chart View");

  if (input) {
    heading.textContent = input;  // Replace with user input
  } else {
    heading.textContent = "Default Heading Text"; // Keep default
  }
}
</script>

<style>
.chart-config-card {
  border: 1px solid #ccc;
  padding: 15px;
  border-radius: 8px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.05);
  margin: 2rem auto;
}
.chart-form {
  border: 1px solid #ccc;
  background: #f9f9f9;
  margin: 20px;
}
.config2-title {
  text-align: center;
  font-weight: bold;
  letter-spacing: 1px;
}
.config-btns {
  justify-content: center;
}
.title-box{
  margin: 1rem auto;
}
</style>

{% endblock %}
