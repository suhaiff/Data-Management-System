{% extends "base.html" %}
{% block content %}
<div class="nav-buttons">
  <button onclick="history.back()" class="btn btn-secondary">
    <i class="fas fa-arrow-left me-1"></i> Previous
  </button>
  <a href="/" class="btn btn-primary">
    <i class="fas fa-home me-1"></i> Home
  </a>
  <button onclick="history.forward()" class="btn btn-secondary">
    Next <i class="fas fa-arrow-right ms-1"></i>
  </button>
</div>

<h2 class="config-title">Chart Configuration - Define Join</h2>

<!-- Flash messages -->
{% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
    {% for category, message in messages %}
      <div class="alert alert-{{ 'danger' if category == 'error' else category }}">
        {{ message }}
      </div>
    {% endfor %}
  {% endif %}
{% endwith %}

<form id="joinForm" method="POST" action="{{ url_for('data_model') }}">
  <div id="joinRows">
    <div class="row join-row mb-3 mt-4">
      <div class="col-md-3">
        <label>Left Column</label>
        <select class="form-select left-col" name="left_col[]" required>
          {% for sheet, cols in available_columns.items() %}
            <optgroup label="{{ sheet }}">
              {% for c in cols %}
                <option value="{{ c.option }}">{{ c.option }}</option>
              {% endfor %}
            </optgroup>
          {% endfor %}
        </select>
      </div>

      <div class="col-md-3">
        <label>Right Column</label>
        <select class="form-select right-col" name="right_col[]" required>
          {% for sheet, cols in available_columns.items() %}
            <optgroup label="{{ sheet }}">
              {% for c in cols %}
                <option value="{{ c.option }}">{{ c.option }}</option>
              {% endfor %}
            </optgroup>
          {% endfor %}
        </select>
      </div>

      <div class="col-md-2">
        <label>Join Type</label>
        <select class="form-select" name="join_type[]" required>
          <option>Inner Join</option>
          <option>Left Join</option>
          <option>Right Join</option>
          <option>Outer Join</option>
        </select>
      </div>

      <div class="col-md-2 d-flex align-items-end">
        <div class="form-check form-switch">
          <input class="form-check-input" type="checkbox" name="bridge_toggle" id="bridge_toggle">
          <label class="form-check-label" for="bridge_toggle">Bridge</label>
        </div>
      </div>

      <div class="col-md-2 d-flex align-items-end">
        <div class="form-check form-switch">
          <input class="form-check-input" type="checkbox" name="create_preview" id="create_preview">
          <label class="form-check-label" for="create_preview">Preview</label>
        </div>
      </div>
    </div>
  </div>

  <button type="submit" class="next-btn btn btn-primary mt-4">Submit & Define Model</button>
</form>

<style>
  .config-title {
    text-align: center;
    font-weight: bold;
    letter-spacing: 1px;
    margin: auto;
  }
  .next-btn {
    display: block;
    margin: 2rem auto 1rem auto;
  }
  .alert {
    text-align: center;
    width: 80%;
    margin: 1rem auto;
  }
</style>

<script>
document.addEventListener('DOMContentLoaded', function () {
  const joinRows = document.getElementById('joinRows');

  joinRows.addEventListener('click', function (e) {
    if (e.target.classList.contains('addRow')) {
      const row = e.target.closest('.join-row');
      const clone = row.cloneNode(true);
      clone.querySelectorAll('select').forEach(s => s.selectedIndex = 0);
      joinRows.appendChild(clone);
    }
    if (e.target.classList.contains('removeRow')) {
      const rows = document.querySelectorAll('.join-row');
      if (rows.length > 1) {
        e.target.closest('.join-row').remove();
      } else {
        alert('At least one join row is required.');
      }
    }
  });
});
</script>
{% endblock %}